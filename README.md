# Ansible WordPress Deployment with Optimized Nginx Configuration

This repository provides a set of Ansible playbooks to automate the deployment of a WordPress site on an Ubuntu server. It includes an optimized Nginx configuration tailored for WordPress, with support for Cloudflare, ArvanCloud, FastCGI caching, security enhancements, and performance optimizations. A Bash script (`generate_config.sh`) simplifies configuration, and additional tools are installed for server management.

---

## **Features**
- **Automated Setup:** Installs and configures MySQL, Nginx, PHP, Composer, WP-CLI, WordPress, and SSL certificates.
- **Optimized Nginx:** Includes configurations for caching, security headers, Gzip, keepalive, and WordPress-specific rules.
- **CDN Support:** Integrates with Cloudflare and ArvanCloud by syncing IP lists and setting real IP headers.
- **Security:** Implements CSF firewall rules, blocks malicious User-Agents, restricts access to sensitive files, and includes antivirus (`clamav`) and rootkit detection (`rkhunter`).
- **Flexibility:** Uses variables to avoid hardcoding, with a script to generate secure passwords and settings.
- **Server Tools:** Installs `bashtop`, `tmux`, `wget`, `curl`, `nano`, `tar`, `clamav`, `rkhunter`, and `rsync` for enhanced server management.
- **Cache Management:** Adds a custom alias to clear Nginx cache (e.g., `cleancachemysitecom`).

---

## **Prerequisites**
Before using this project, ensure you have the following:
1. **Ansible Installed:** Version 2.9 or higher on your control machine.
   - Install with: `pip install ansible` or `sudo apt install ansible`.
2. **Ubuntu Server:** A target server running Ubuntu 20.04 or 22.04.
3. **SSH Access:** Root or sudo access to the target server with SSH key-based authentication.
4. **Domain Name:** A registered domain pointing to your server's IP address.
5. **OpenSSL:** Required for the `generate_config.sh` script to generate secure passwords.
   - Install with: `sudo apt install openssl`.

---

## **Directory Structure**
```
project/
├── group_vars/
│   └── all.yml             # Variables file (generated by generate_config.sh)
├── templates/
│   └── nginx.conf.j2       # Nginx configuration template
├── examplehelper/
│   ├── arvancloud-ip-sync.sh  # Syncs ArvanCloud IPs
│   ├── cache.conf          # Caching rules
│   ├── cloudflare-ip-sync.sh  # Syncs Cloudflare IPs
│   ├── cloudflare.conf     # Cloudflare IP list
│   ├── filemanager.conf    # File manager settings
│   ├── general.conf        # General Nginx rules
│   ├── gzip.conf           # Gzip compression settings
│   ├── keepalive.conf      # Keepalive settings
│   ├── redirects.conf      # URL redirects
│   ├── securityheaders.conf # Security headers
│   └── wordpress.conf      # WordPress-specific rules
├── 00-update-upgrade.yml   # Updates system and installs tools
├── 01-install-mysql.yml    # Installs MySQL
├── 02-install-nginx.yml    # Installs Nginx and helper files
├── 03-install-php-composer-wpcli.yml # Installs PHP, Composer, and WP-CLI
├── 04-install-wordpress.yml # Installs and configures WordPress
├── 05-obtain-ssl.yml       # Obtains SSL certificate with Certbot
└── generate_config.sh      # Script to generate group_vars/all.yml
```

---

## **Installation and Usage**

### **Step 1: Clone the Repository**
Clone this repository to your control machine:
```bash
git clone <repository-url>
cd project
```

### **Step 2: Generate Configuration**
Run the `generate_config.sh` script to create or update `group_vars/all.yml` with secure, auto-generated values:
```bash
chmod +x generate_config.sh
./generate_config.sh
```

- **Prompts:** The script will ask for:
  - Domain name (e.g., `mysite.com`)
  - WordPress admin username (e.g., `admin`)
  - WordPress admin email (e.g., `admin@mysite.com`)
  - WordPress site title (e.g., `My Site`)
  - WordPress locale (e.g., `en_US` or `fa_IR`)
  - SSL email for Certbot (e.g., `your@email.com`)
  - PHP version (e.g., `8.3`)
  - Linux username (e.g., `ubuntu`)
- **Generated Values:** It automatically creates secure passwords and database settings (e.g., `mysql_root_password`, `wordpress_db_prefix`).
- **Encryption Option:** You can choose to encrypt the file with Ansible Vault (recommended for security).

**Example Output:**
```
Configuration file 'group_vars/all.yml' has been created with the following values:
------------------------------------------------
MySQL Root Password: Kj9mPx2vL8nQ7rT4wY6c
MySQL Database Name: wp_mysitecom
MySQL Database User: wpuser_mysitecom
MySQL Database Password: B5tZ8pW3qX9vM2rJ6nYk
WordPress Admin Password: H7kL4mP9vR2tQ8wX5nYc
WordPress Database Prefix: kh_
------------------------------------------------
Please save these values in a secure place!
```

If encrypted, note the Vault password for later use.

### **Step 3: Set Up Inventory**
Create an `inventory` file with your target server’s IP or hostname:
```
[wordpress]
your_server_ip ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/your_key
```

Replace `your_server_ip` and `your_key` with your actual server IP and SSH key path.

### **Step 4: Run the Playbooks**
Execute the playbooks in sequence:
```bash
ansible-playbook -i inventory \
  00-update-upgrade.yml \
  01-install-mysql.yml \
  02-install-nginx.yml \
  03-install-php-composer-wpcli.yml \
  04-install-wordpress.yml \
  05-obtain-ssl.yml
```

If `all.yml` is encrypted, add the Vault password flag:
```bash
ansible-playbook -i inventory --ask-vault-pass ...
```

### **Step 5: Verify**
- Visit `https://yourdomain.com` to ensure WordPress is running.
- Log in with the admin credentials displayed by `generate_config.sh`.
- Check Nginx logs at `/var/www/yourdomain.com/logs/`.
- Use the alias to clear Nginx cache (e.g., `cleancachemysitecom`) after logging into the server via SSH and running `source ~/.bashrc`.

---

## **Playbook Details**

1. **`00-update-upgrade.yml`**
   - Updates package lists and upgrades all packages.
   - Installs additional tools: `bashtop`, `tmux`, `wget`, `curl`, `nano`, `tar`, `clamav`, `rkhunter`, `rsync`.
   - Adds an alias to `.bashrc` for clearing Nginx cache (e.g., `cleancachemysitecom`).

2. **`01-install-mysql.yml`**
   - Installs MySQL, sets the root password, and creates a database and user for WordPress.

3. **`02-install-nginx.yml`**
   - Installs Nginx and CSF firewall, copies helper configuration files, and syncs Cloudflare/ArvanCloud IPs.

4. **`03-install-php-composer-wpcli.yml`**
   - Installs PHP (configurable version), Composer, and WP-CLI with optimized settings.

5. **`04-install-wordpress.yml`**
   - Configures Nginx with the custom template, installs WordPress, and sets proper permissions.

6. **`05-obtain-ssl.yml`**
   - Installs Certbot and obtains an SSL certificate for your domain.

---

## **Nginx Configuration**
The Nginx setup (`templates/nginx.conf.j2`) is optimized for WordPress with:
- **FastCGI Caching:** Caches dynamic PHP content for 30 minutes, manageable via the `cleancache<domain>` alias.
- **Security Headers:** Protects against XSS, clickjacking, and more.
- **CDN Integration:** Supports Cloudflare and ArvanCloud real IPs.
- **WordPress Rules:** Blocks access to sensitive files and throttles `wp-login.php`.

Helper files in `examplehelper/` are copied to `/etc/nginx/sites-available/yourdomainhelper/` and included dynamically.

---

## **Security Notes**
- **Passwords:** The `generate_config.sh` script generates secure, random passwords. Store them safely after running the script.
- **Encryption:** Use Ansible Vault to encrypt `group_vars/all.yml` for added security.
- **Firewall:** CSF is configured to whitelist Cloudflare and ArvanCloud IPs.
- **File Permissions:** WordPress files are set to `664` and directories to `775`, owned by `www-data`.
- **Antivirus & Rootkit Detection:** `clamav` and `rkhunter` are installed for manual security scans.

---

## **Troubleshooting**
- **Nginx Errors:** Check logs at `/var/www/yourdomain.com/logs/error.log`.
- **MySQL Issues:** Ensure the MySQL service is running (`sudo systemctl status mysql`).
- **SSL Problems:** Verify Certbot logs at `/var/log/letsencrypt/`.
- **Permission Denied:** Confirm the Ansible user has sudo privileges.
- **Vault Errors:** If encrypted, ensure you provide the correct Vault password with `--ask-vault-pass`.
- **Alias Not Working:** Run `source ~/.bashrc` or reconnect to the SSH session.

---

## **Customization**
- **Change PHP Version:** Specify your desired version when running `generate_config.sh`.
- **Add Redirects:** Edit `examplehelper/redirects.conf`.
- **Modify Security Headers:** Adjust `examplehelper/securityheaders.conf`.
- **Run Security Scans:** Use `clamav` (`clamscan`) or `rkhunter` (`rkhunter --check`) manually as needed.

---

## **Contributing**
Feel free to submit issues or pull requests to improve this project!

---

## **License**
This project is licensed under the MIT License.

